# 发票合并助手（Invoice Merge Assistant）

一款桌面应用，用于将多个发票 PDF 合并为单一文档，并支持自动内容检测与网格布局排版。

## 功能特性

- **导入多个 PDF**：添加并管理多份发票 PDF 文件
- **智能裁剪**：自动检测发票内容边界  
  - 自动模式：基于 PDF 对象（文本、绘图、图片）检测内容区域  
  - 上半页模式：裁剪页面上半部分（比例可配置）  
  - 手动模式：用户自定义裁剪区域
- **网格布局**：按可配置的行列数将发票排列到网格中
- **矢量质量**：输出时保留 PDF 矢量质量
- **预览**：查看所选发票的缩略图
- **排序调整**：上移/下移以改变合并顺序

## 环境要求

- Python 3.10 或更高版本
- PyMuPDF (fitz) >= 1.23
- Pillow >= 10.0
- NumPy >= 1.24

## 安装

1. 克隆或下载本仓库
2. 安装依赖：

```bash
pip install -r requirements.txt
```

## 使用方法

运行应用：

```bash
python invoice_merge_gui.py
```

### 基本流程

1. **添加文件**：点击 “Add Files” 选择发票 PDF
2. **调整顺序**（可选）：使用 “Move Up” / “Move Down” 进行排序
3. **配置布局**：设置网格的行数与列数
4. **选择裁剪模式**：选择 自动 / 上半页 / 手动 裁剪
5. **导出**：点击 “Export Merged PDF” 保存合并结果

## 项目结构

```
invoice2/
├── core/
│   ├── models.py          # 数据模型
│   ├── pdf_engine.py      # PDF 操作封装
│   ├── cropper.py         # 裁剪算法
│   ├── layout.py          # 网格布局计算
│   ├── merger.py          # PDF 合并逻辑
│   └── tasks.py           # 后台任务处理
├── storage/
│   └── persist.py         # 配置持久化
├── invoice_merge_gui.py   # 主 GUI 应用
├── requirements.txt       # Python 依赖
└── README.md              # 原始说明文件
```

## 裁剪模式说明

### 自动模式（推荐）
通过以下方式自动检测发票内容边界：
- 文本块分析
- 绘图对象检测
- 图片边界检测
- 对扫描版 PDF 退化为基于像素的检测

### 上半页模式
裁剪页面上半部分（默认 55%）。适用于发票只占据 A4 纸上半部分的场景。

### 手动模式
通过预览画布让用户自定义裁剪区域（计划在未来版本实现）。

## 技术细节

### 架构
- **模块化设计**：职责拆分（PDF 引擎、裁剪、布局、GUI）
- **保留矢量**：使用 PyMuPDF 的 `show_pdf_page` 进行内容级拼版
- **智能检测**：优先对象级检测，对扫描件再降级为像素检测
- **缓存**：缩略图与裁剪结果缓存以提升性能

### 关键算法
- **基于对象的裁剪**：分析 PDF 结构（文本、绘图、图片）
- **基于像素的裁剪**：对扫描件使用阈值法检测内容区域
- **网格布局**：在单元格内自动缩放并居中
- **内容保真**：矢量 PDF 无质量损失

## 故障排查

### 加密 PDF
本应用无法处理加密/带密码的 PDF。请先移除加密后再导入。

### 自动裁剪效果不佳
- 若发票位于页面上半部分，可尝试 **上半页模式**
- 调整 `CropConfig` 中的 `top_half_ratio`（默认：0.55）
- 对扫描件，可调整 `pixel_threshold`（默认：245）

### 内存问题
对于大批量文件（100+），应用使用缓存来更高效地管理内存。

## 许可证

本项目按“原样”提供，可用于教育与商业用途。

## 贡献

欢迎贡献！请确保代码遵循现有架构，并包含适当的错误处理。
